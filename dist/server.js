var relaciones={"ad_menu_1":{pkey:"ID_AUTO_MEN1"},"ad_menu_2":{pkey:"ID_AUTO_MEN2"},"ad_modulos":{pkey:"ID_AUTO_MODU"},"ad_perfiles":{pkey:"ID_AUTO_PERF"},"sys_festivos":{pkey:"ID_FESTIVO"},"sys_empresas_diashabiles":{pkey:"ID_REG"},"sgd_ingresos":{pkey:"ID_INGRESO"},"sgd_medios":{pkey:"ID_MEDIO"},"sgd_movimientos":{pkey:"ID_MOVIMIENTO"},"sgd_prestamos":{pkey:"ID_PRESTAMO"},"sys_normograma_tipos":{pkey:"ID_AUTO_TINO"},"sys_normograma":{pkey:"ID_NORMA"},"sgd_trd_version":{pkey:"ID_VERSION"},"sgd_trd_series":{pkey:"ID_SERIE"},"sgd_trd_subseries":{pkey:"ID_SUBSERIE"},"sgd_trd_tipos_documentales":{pkey:"ID_TIPO"},"sgd_unidades_documentales":{pkey:"ID_AUTO_UNDO"},"sys_cargos":{pkey:"ID_AUTO_CARG"},"sys_empresas":{pkey:"ID_AUTO_EMPR"},"sys_empresas_contratos":{pkey:"ID_AUTO_EMCO"},"sys_municipios":{pkey:"ID_AUTO_MUNI"},"sys_paises":{pkey:"ID_AUTO_PAIS"},"sys_r_unidades_documentales_usuarios":{pkey:"ID_AUTO_R_UNDO_USUA"},"sys_usuarios":{pkey:"ID_AUTO_USUA"},"sys_tipos_identidades":{pkey:"ID_AUTO_TIID"},"sys_tipos_vinculacion":{pkey:"ID_AUTO_TIVI"},"sys_tratamientos_terceros":{pkey:"ID_AUTO_TRPE"},"ges_actividades_tipos_grupos":{pkey:"ID_GRUPO"},"ges_actividades_tipos":{pkey:"ID_TIPO_ACTIVIDAD"},"ges_actividades":{pkey:"ID_ACTIVIDAD"},"ges_metas_grupos":{pkey:"ID_GRUPO"},"ges_actividades_indicadores":{pkey:"ID_INDICADOR"},"ges_ejes":{pkey:"ID_EJE"},"ges_sectores":{pkey:"ID_SECTOR"},"ges_metas":{pkey:"ID_META"},"ges_datos":{pkey:"ID_DATO"},"ges_datos_periodo":{pkey:"ID_DATO_PERIODO"},"ges_indicadores_metas":{pkey:"ID_META"},"ges_medidas":{pkey:"ID_MEDIDA"},"spt_esquemas":{pkey:"ID_ESQUEMA"},"spt_informes":{pkey:"ID_INFORME"},"spt_informes_fechas":{pkey:"ID_FECHA"},"ges_periodos":{pkey:"ID_PERIODO"},"ges_planes":{pkey:"ID_PLAN"},"ges_programas":{pkey:"ID_PROGRAMA"},"ges_subprogramas":{pkey:"ID_SUBPROGRAMA"},"sgd_documental":{pkey:"ID_DOCUMENTO"},"sgd_expedientes":{pkey:"ID_EXPEDIENTE"},"sgd_expedientes_plantillas":{pkey:"ID_PLANTILLA"},"sgd_expedientes_plantillas_documentos":{pkey:"ID_DOCUMENTO"},"sgd_expedientes_composicion":{pkey:"ID_REL"},"sgd_banco_apoyo":{pkey:"ID_ITEM"},"sys_notas":{pkey:"ID_NOTE"},"sys_anuncios":{pkey:"ID_NOTE"},"agenda_permisos":{pkey:"ID_REL"},"spt_informes_ejecutivos":{pkey:"ID_INFORME"},"sys_soporte":{pkey:"ID_CASO"},"sys_soporte_seguimiento":{pkey:"ID_CASO"},"pro_main":{pkey:"ID_PROYECTO"},"pro_object":{pkey:"ID_OBJETIVO"},"pro_task":{pkey:"ID_TAREA"},"sgc_tipos_calidad":{pkey:"ID_TIPO"},"sgc_documental":{pkey:"ID_DOCUMENTO"},"sgc_documental_version":{pkey:"ID_VERSION"},"ges_plan":{pkey:"ID_PLAN"},"ges_plan_estructura":{pkey:"ID_ITEM"},"ges_tipos_actividades":{pkey:"ID_TIPO"},"ges_plan_indicadores":{pkey:"ID_REL"},"ges_metas_proyectos":{pkey:"ID_REL"},"ges_metas_metas":{pkey:"ID_REL"},"ges_metas_analisis":{pkey:"ID_REGISTRO"},"eventos":{pkey:"ID_EVENTO"},"eventos_seguimiento":{pkey:"ID_ITEM"},"sgd_documental_permisos":{pkey:"ID_PERMISO"},"sgd_expedientes_documentos":{pkey:"ID_REL"},"sgd_expedientes_cruzados":{pkey:"ID_REL"},"ges_datos_registros":{pkey:"ID_REL"},"ges_r_meta_grupo":{pkey:"ID_REL"},"ges_metas_presupuesto":{pkey:"ID_REGISTRO"},"ges_metas_beneficiarios":{pkey:"ID_REGISTRO"},"ges_planes_tipos":{pkey:"ID_TIPO_PLAN"},"ges_auditorias":{pkey:"ID_AUDITORIA"},"ges_auditoria_plan":{pkey:"ID_PLAN"},"ges_auditoria_checklist":{pkey:"ID_CHECK"},"ges_presupuesto_origenes":{pkey:"ID_ORIGEN"},"ges_segmentos":{pkey:"ID_SEGMENTO"},"ges_segmentos_grupos":{pkey:"ID_GRUPO"},"sgd_transporte":{pkey:"ID_TRANSPORTE"},"sgd_despachos":{pkey:"ID_DESPACHO"},"ges_plan_verificacion":{pkey:"ID_VERIFICACION"},"sys_active_pause":{pkey:"ID_PAUSA"},"sys_prioridades":{pkey:"ID_PRIORIDAD"},"sys_videos":{pkey:"ID_VIDEO"},"sgd_mail_boxes":{pkey:"ID_BOX"},"sgd_einbox_rules":{pkey:"ID_RULE"},"sys_tramites":{pkey:"ID_TRAMITE"},"sys_instructivos":{pkey:"ID_INSTRUCTIVO"},"sys_tramites_estructura":{pkey:"ID_ITEM"},"sys_tramites_forms":{pkey:"ID_CAMPO"},"sys_tramites_forms_select":{pkey:"ID_SELECT"},"poll_main":{pkey:"ID_POLL"},"poll_options":{pkey:"ID_OPTION"},"sys_chat_grupos":{pkey:"ID_GRUPO"},"clb_formatos":{pkey:"ID_FORMATO"},"clb_plantillas":{pkey:"ID_PLANTILLA"},"clb_plantillas_campos":{pkey:"ID_CAMPO"},"clb_plantillas_grupos":{pkey:"ID_GRUPO"},"clb_plantillas_campos_select":{pkey:"ID_SEL"},"clb_plantillas_campos_subtablas":{pkey:"ID_CTABLA"},"clb_plantillas_campos_subtablas_select":{pkey:"ID_SEL"},"clb_records_data":{pkey:"ID_RECORD"},"af_activos":{pkey:"ID_ACTIVO"},"af_tipos_activos":{pkey:"ID_ACTIVO"},"sys_usuarios_grupos":{pkey:"ID_GRUPO"},"clb_collections":{pkey:"ID_COLLECTION"},"sys_vigencias":{pkey:"ID_VIGENCIA"},"sys_prioridades":{pkey:"ID_PRIORIDAD"},"sys_barrios_veredas":{pkey:"ID_AUTO_BAVE"},"actas_actas":{pkey:"ID_ACTA"},"clb_image_data":{pkey:"ID_IMAGE"}};

var fs = require('fs');
var http = require('http');
var https = require('https');
var crypto = require('crypto');

/*ADDDDDDDD TO SERVER*/

var jwt = require('jwt-simple');  
var moment = require('moment');  
var config = require('./kongfig');
var bodyParser = require('body-parser');
var methodOverride = require("method-override");


//GMAIL
var {google} = require('googleapis');
var SCOPES = ['https://www.googleapis.com/auth/gmail.modify','profile','email'];

var oAuth2Client = new google.auth.OAuth2("578033565210-q0a6ms10c12b4ht16itbg4tvpi04lug7.apps.googleusercontent.com", "7P9zZ7HHNqqAWX0DNUezUUMY", "https://sge.torresoft.co");
var authUrl = oAuth2Client.generateAuthUrl({
	access_type: 'offline',
	scope: SCOPES,
});

////GMAIL

var middleware = require('./medioware');
var service = require('./tokenner');

exports.createToken = function(user) {  
  var payload = {
    sub: user._id,
    iat: moment().unix(),
    exp: moment().add(14, "days").unix(),
  };
  return jwt.encode(payload, config.TOKEN_SECRET);
};

var privateKey  = fs.readFileSync('/etc/pki/tls/private/*.torresoft.co.key', 'utf8');
var certificate = fs.readFileSync('/etc/pki/tls/certs/*.torresoft.co.crt', 'utf8');

var credentials = {key: privateKey, cert: certificate};
var express = require('express');
var formidable = require('formidable');
var util = require('util');
var socketioJwt   = require("socketio-jwt");
var mysql      = require('mysql');

var connection = mysql.createConnection({
   host     : 'localhost',
   user     : 'plexo',
   password : 'dbUsG3N3R4L+rh0-',
   database : 'sge3',
   timezone : 'UTC+0',
   multipleStatements: true
});
var connection_rest = mysql.createConnection({
   host     : 'localhost',
   user     : 'plexo',
   password : 'dbUsG3N3R4L+rh0-',
   database : 'rest',
   timezone : 'UTC+0',
   multipleStatements: true
});

/*
var connection = mysql.createConnection({
   host     : '127.0.0.1',
   user     : 'root',
   password : 'KernelPass530+',
   database : 'sge2018'
});
*/

var app = express();

//  ADDD TO SERVER*/
app.use(function(req, res, next) {
	res.header('Access-Control-Allow-Origin', "*"); 
	res.header('Access-Control-Allow-Methods','GET,PUT,POST'); 
	res.header("Access-Control-Allow-Credentials","true"); 
	res.header("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, Accept, Autorization, authorization");
	next();
})

app.set('superSecret', config.secret); // secret variable
// Middlewares


app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());
app.use(methodOverride());


//var httpServer = http.createServer(app);
var httpsServer = https.createServer(credentials, app);

//httpServer.listen(3000);
var io = require('socket.io').listen(httpsServer);
io.origins((origin, callback) => {
  if (origin !== 'https://sge.torresoft.co') {
    return callback('origin not allowed', false);
  }
  callback(null, true);
});

httpsServer.listen(3443);

app.get('/', function(req, res) {
 res.send('Hola! Muchach@!');
});


//GMAIL
app.get("/api/gmail/status",middleware.ensureAuthenticated,function(req,res){
	var id_usr=req.user;
	var id_bus=req.bus;
	var TOKEN_PATH="/var/node/tokens/token"+id_usr+".json";
	if (fs.existsSync(TOKEN_PATH)) {
		var tk = JSON.parse(fs.readFileSync(TOKEN_PATH, 'utf8'));
		oAuth2Client.setCredentials(tk);
		res.send({status:"ok"})
	}else{
		res.send({status:"loggin",url:authUrl})
	}
});

app.get('/api/gmail/get_token',middleware.ensureAuthenticated, (req, res, next) => {
	var id_usr=req.user;
	var id_bus=req.bus;
	var code=req.query.code;
	var TOKEN_PATH="/var/node/tokens/token"+id_usr+".json";
  oAuth2Client.getToken(code, (err, tokens) => {
    if (err) return next(err);
	
     oAuth2Client.setCredentials(tokens);
	   try{
		fs.writeFileSync(TOKEN_PATH, JSON.stringify(tokens),'utf8');
		res.send({status:"ok",data:tokens});
	  }catch(e){
		res.send({status:"error",data:"Error al guardar token"});
	  }
  });
});


app.get("/api/gmail/get_labels",middleware.ensureAuthenticated,function(req,res){
	var id_usr=req.user;
	var id_bus=req.bus;
	var TOKEN_PATH="/var/node/tokens/token"+id_usr+".json";
	if (fs.existsSync(TOKEN_PATH)) {
		var tk = JSON.parse(fs.readFileSync(TOKEN_PATH, 'utf8'));
		oAuth2Client.setCredentials(tk);
	const gmail = google.gmail({version: 'v1', oAuth2Client});
	  gmail.users.labels.list({
		userId: 'me',
	  }, (err, resg) => {
		if (err) return console.log('The API returned an error: ' + err);
		const labels = resg.data.labels;
		res.send({status:"ok",labels:labels});
	  });
	}else{
		res.send({status:"error",msg:"No Login"});
	}
});



/////GMAIL

app.post("/api/auth",function(req,res){
	var username=req.body.username;
	var password=req.body.password;	
	connection.query('SELECT T.ID_AUTO_USUA, T.ID_IDEN_TERC, CONCAT(T.TX_PNOM_TERC," ",T.TX_SNOM_TERC," ",T.TX_PAPE_TERC," ",T.TX_SAPE_TERC) AS NOMBRE, T.TX_MAIL_TERC, T.TX_IMAG_TERC, T.CD_SEXO_TERC, T.CD_CODI_EMPR, T.JOURNEY, E.ID_AUTO_EMPR, E.TX_NOMB_EMPR, E.TX_IMAG_EMPR FROM sys_usuarios AS T JOIN sys_empresas E ON E.ID_AUTO_EMPR=T.CD_CODI_EMPR WHERE T.TX_MAIL_TERC=? AND T.TX_PASS_USUA=md5(?) AND T.BO_ESTA_USUA="1" AND T.TUX="I" AND T.FECHA_TERMINACION>=CURDATE() AND T.CD_CODI_EMPR IN(SELECT CD_AUTO_EMPR_EMCO FROM sys_empresas_contratos WHERE CURDATE() BETWEEN FE_FECH_INIC_EMCO AND FE_FECH_FINA_EMCO) GROUP BY T.ID_AUTO_USUA',[username,password], function(err, result) {
		if(result.length==1){
			var user={_id:result[0].ID_AUTO_USUA,_nm:result[0].NOMBRE}
			var resulta={
				success: true,
				status:"goin",
				message: 'Token creado',
				id_bus:result[0].ID_AUTO_EMPR,
				id_user:result[0].ID_AUTO_USUA,
				token: service.createToken(user)
			}
			res.json(resulta);
		}else if(result.length>1){
			var user={_id:result.ID_AUTO_USUA,_nm:result.NOMBRE}
			var resulta={
				success: true,
				status:"selectbus",
				message: 'Selecciona la empresa',
				options: result
			}
			res.json(resulta);
		}else{
			res.json({success:false,"message":"El usuario o clave no son v�lidos"});
		}
	});
});


app.post("/api/auth-select-bus",function(req,res){
	var username=req.body.username;
	var password=req.body.password;	
	var business=req.body.business;	
	connection.query('SELECT T.ID_AUTO_USUA, T.ID_IDEN_TERC, CONCAT(T.TX_PNOM_TERC," ",T.TX_SNOM_TERC," ",T.TX_PAPE_TERC," ",T.TX_SAPE_TERC) AS NOMBRE, T.TX_MAIL_TERC, T.TX_IMAG_TERC, T.CD_SEXO_TERC, T.CD_CODI_EMPR, T.JOURNEY, E.ID_AUTO_EMPR, E.TX_NOMB_EMPR, E.TX_IMAG_EMPR FROM sys_usuarios AS T JOIN sys_empresas E ON E.ID_AUTO_EMPR=T.CD_CODI_EMPR WHERE T.TX_MAIL_TERC=? AND T.TX_PASS_USUA=md5(?) AND T.BO_ESTA_USUA="1" AND E.ID_AUTO_EMPR=? AND T.TUX="I" AND T.FECHA_TERMINACION>=CURDATE() AND T.CD_CODI_EMPR IN(SELECT CD_AUTO_EMPR_EMCO FROM sys_empresas_contratos WHERE CURDATE() BETWEEN FE_FECH_INIC_EMCO AND FE_FECH_FINA_EMCO) GROUP BY T.ID_AUTO_USUA',[username,password,business], function(err, result) {
		if(result.length==1){
			var user={_id:result[0].ID_AUTO_USUA,_nm:result[0].NOMBRE}
			var resulta={
				success: true,
				status:"goin",
				message: 'Token creado',
				id_bus: result[0].ID_AUTO_EMPR,
				id_user:result[0].ID_AUTO_USUA,
				token: service.createToken(user)
			}
			res.json(resulta);
		}else if(result.length>1){
			var user={_id:result[0].ID_AUTO_USUA,_nm:result[0].NOMBRE}
			var resulta={
				success: true,
				status:"selectbus",
				message: 'Selecciona la empresa',
				options: result
			}
			res.json(resulta);
		}else{
			res.json({success:false,"message":"El usuario o clave no son v�lidos"});
		}
	});
});


//httpsServer.listen(3443);
//var io = require('socket.io').listen(app.listen(3443));

io.use(socketioJwt.authorize({
  secret: config.TOKEN_SECRET,
  handshake: true
}));

 connection.connect(function(err){
 if(!err) {
	 console.log("Conectado a la BD ... \n\n");  
 } else {
	 console.log("Error accediendo al servidor de datos... \n\n"+err);  
 }
 }); 
 connection_rest.connect(function(err){
 if(!err) {
	 console.log("DataFeed OK ... \n\n");  
 } else {
	 console.log("Error accediendo al servidor de datos... \n\n"+err);  
 }
 }); 


app.get("/api/kal",middleware.ensureAuthenticated,function(req,res){
	res.json({success:true,status:"Sigues ahí"});
});


var connusers=[];
io.sockets.on('connection', function (socket) {
	
    socket.on('entra', function (cliente) {
		var id_me=socket.decoded_token.sub;
		var isconn=false;
		for(var i=0;i<connusers.length;i++){
			if(connusers[i].id==id_me){
				isconn=true;
				connusers[i].sid=socket.id;
				break;
			}
		}
		var noticonn=cliente.notif;
		if(!isconn){
			connusers.push({id:id_me,sid:socket.id});
			
			if(noticonn==1){
				io.sockets.emit("seconecto", {id_me:id_me,noti:noticonn});
			}
			socket.emit('joinconn',{});
			
		}
		console.log("Login: "+id_me);
		connection.query('SELECT ID_MSG, ID_FROM, ID_TO, PRIV, VISTO, MSG, FECHA, IF(ID_TO=0,"G","I") AS TP from sys_chat WHERE (ID_TO=? OR (ID_TO=0 AND PRIV IN(SELECT ID_GRUPO FROM sys_chat_grupos_usuarios WHERE ID_USUARIO=? AND FLAG_VISTO=0 ORDER BY ID_GRUPO))) GROUP BY ID_FROM, TP ORDER BY ID_MSG',[id_me,id_me,id_me,id_me], function(err, rows, fields) {
			socket.emit("misnuevos",rows);
		});
		io.sockets.emit("set_conectados", connusers);
    });
	
	socket.on('get_conn', function (cliente) {
		var id_me=socket.decoded_token.sub;
		if(id_me>0){
			socket.emit('set_conectados', connusers);
		}
	});

	socket.on('joinus', function (cliente) {
		var id_me=socket.decoded_token.sub;
		var id_you=cliente.you;
		if(id_me>0 && id_you>0){
			connection.query('SELECT ID_MSG, ID_FROM, ID_TO, MSG, FECHA, VISTO FROM sys_chat WHERE ((ID_TO=? AND ID_FROM=?) OR (ID_TO=? AND ID_FROM=?))  ORDER BY ID_MSG DESC LIMIT 200',[id_me,id_you,id_you,id_me], function(err, rows, fields) {
			if (!err){
				connection.query('UPDATE LOW_PRIORITY sys_chat SET VISTO=1 WHERE ID_TO=? AND ID_FROM=?',[id_me,id_you], function(err, rows, fields) {});
				socket.emit("messjoin",{me:id_me,you:id_you,rows:rows});
			}else{
				socket.emit("error1");
			}
		});
		}
    });
	socket.on('message', function (cliente) {
		var id_from=socket.decoded_token.sub;
		var id_to=cliente.you;
		var mess=cliente.mess;

		if(id_from>0){
			connection.query('INSERT INTO sys_chat (ID_FROM,ID_TO,MSG,FECHA) VALUES (?,?,?,NOW())',[id_from,id_to,mess], function(err, result) {

				if(err) throw err;
				var id_mess = result.insertId;
				socket.emit('msgsent', {id_to:id_to,mess:mess,id_mess:id_mess});
				getSid(id_to).then(function(cl_id_to){
					//console.log(id_to+mess);
					socket.to(cl_id_to).emit('msgget', {id_from:id_from,mess:mess,id_mess:id_mess});
				});
				
				
			});
			
		}
		
    });
	
	socket.on('telei', function (cliente) {
		var id_from=cliente.you;
		var id_to=socket.decoded_token.sub;
		if(id_to>0 && id_from>0){
			connection.query('UPDATE LOW_PRIORITY sys_chat SET VISTO="1" WHERE ID_FROM=? AND ID_TO=?',[id_from,id_to], function(err, result) {
				//connection.end();
				if(err) throw err;
				getSid(id_from).then(function(cl_id_from){
					socket.to(cl_id_from).emit('leidos', {id_to:id_to});
				});
				
				
			});
			
		}
		
    });
	
	
	socket.on('newgroup', function (cliente) {
		var id_from=socket.decoded_token.sub;
		var id_to=cliente.id_to;

		if(id_from>0 && id_to!=""){
			var rows=id_to.split("|");
			for(var nd=0;nd<rows.length;nd++){
				var idus=rows[nd];
				if(idus!="" && idus>0){
					getSid(idus).then(function(cl_id_to){
						socket.to(cl_id_to).emit('newgrpchat', {id_from:id_from});
					});
				}
			}		
		}
		
    });
		
	
	socket.on('leisup', function (cliente) {
		var id_from=cliente.you;
		var id_to=socket.decoded_token.sub;
		if(id_to>0){
			getSid(id_from).then(function(cl_id_from){
				socket.to(cl_id_from).emit('leidos', {id_to:id_to});
			});	
		}
		
    });
	
	
	
	/////---grupos
	
	
	socket.on('joinus_gr', function (cliente) {
		var id_me=socket.decoded_token.sub;
		var id_you=cliente.you;
		if(id_me>0){
			connection.query('SELECT ID_MSG, ID_FROM, ID_TO, MSG, FECHA, VISTO FROM sys_chat WHERE PRIV=? AND ID_TO="0" ORDER BY ID_MSG DESC LIMIT 300',[id_you], function(err, rows, fields) {
			if (!err){
				socket.emit("messjoin_gr",{me:id_me,you:id_you,rows:rows});
			}else{
				socket.emit("error1");
			}
		});
		}
    });
	socket.on('message_gr', function (cliente) {
		var id_from=socket.decoded_token.sub;
		var id_to=cliente.you;
		var mess=cliente.mess;
		if(id_from>0 && mess!=""){
			connection.query('INSERT INTO sys_chat (ID_FROM,PRIV,MSG,FECHA) VALUES (?,?,?,NOW())',[id_from,id_to,mess], function(err, result) {
				//connection.end();
				var id_mess = result.insertId;
				socket.emit('msgsent_gr', {id_to:id_to,mess:mess,id_mess:id_mess});
				if(err) throw err;
				connection.query('SELECT ID_USUARIO FROM sys_chat_grupos_usuarios WHERE ID_GRUPO=? ORDER BY ID_USUARIO',[id_to], function(err, rows, fields) {
					if (!err){
						connection.query('UPDATE sys_chat_grupos_usuarios SET FLAG_VISTO=0 WHERE ID_GRUPO=? AND ID_USUARIO<>? ORDER BY ID_USUARIO',[id_to,id_from], function(err3, resulta) {});
						for(var nd=0;nd<rows.length;nd++){
							var idus=rows[nd]["ID_USUARIO"];
							getSid(idus).then(function(cl_id_to){
								socket.to(cl_id_to).emit('msgget_gr', {id_from:id_from,id_to:id_to,mess:mess,id_mess:id_mess});
							});
						}
						
					}else{
						res.send(403);
					}
				});
				
			});
			
		}
		
    });
		
	socket.on('leisup_gr', function (cliente) {
		var id_from=cliente.you;
		var id_to=socket.decoded_token.sub;
		if(id_to>0){
			getSid(id_from).then(function(cl_id_from){
				socket.to(cl_id_from).emit('leidos_gr', {id_to:id_to});
			});	
		}
		
    });
	
	socket.on('telei_gr', function (cliente) {
		var id_from=socket.decoded_token.sub;
		var id_to=cliente.you;
		if(id_from>0){
			connection.query('UPDATE LOW_PRIORITY sys_chat_grupos_usuarios SET FLAG_VISTO="1" WHERE ID_USUARIO=? AND ID_GRUPO=?',[id_from,id_to], function(err, result) {
				//connection.end();
				if(err) throw err;
			
				getSid(id_from).then(function(cl_id_from){
					socket.to(cl_id_from).emit('leidos_gr', {id_to:id_to});
				});
				
				
			});
			
		}
		
    });
	
	//////--grupos


		
	socket.on('ilike', function (cliente) {
		
		var id_me=socket.decoded_token.sub;
		var id_anounce=cliente.id_anounce;
		if(id_me>0){
			connection.query('INSERT IGNORE INTO sys_anuncios_like (ID_ANUNCIO,ID_USUARIO,FECHA) VALUES (?,?,NOW())',[id_anounce,id_me], function(err, result) {
				io.sockets.emit('liked', {id_anounce:id_anounce});
			});
		}
		
    });
	
	
	socket.on('newmail', function (cliente) {
		
		var id_me=socket.decoded_token.sub;
		var id_to=cliente.id_to.split("|");

		if(id_me>0){
			for(var n=0;n<id_to.length;n++){
				if(id_to[n]!=""){
					getSid(id_to[n]).then(function(cl_id_go){
						socket.to(cl_id_go).emit('newmail_go',{});
					});
				}
			}			
		}
		
    });
	
	socket.on("chao", function(cliente){
		var idcl=socket.decoded_token.sub;
		for(var i=0;i<connusers.length;i++){
			if(connusers[i].id==idcl){
				connusers.splice(i, 1);
				break;
			}
		}
        io.sockets.emit("set_conectados", connusers);
    });
	
	
	socket.on('disconnect', function(){
		for(var i=0;i<connusers.length;i++){
			if(connusers[i].sid==socket.id){
				connusers.splice(i, 1);
				break;
			}
		}
		io.sockets.emit("set_conectados", connusers);
	});
	
	socket.on("anounce_in", function(cliente){
        io.sockets.emit("anounce_go", connusers);
    });
	
	socket.on("notice_in", function(cliente){
		var notis=cliente.notis.split("|");
		for(var i=0;i<notis.length;i++){
			var id_from=notis[i];
			if(id_from!=undefined && id_from!=""){
				getSid(id_from).then(function(cl_id_from){
					socket.to(cl_id_from).emit('notice_go', {});
				});
			}
		}

    });
	
	
	
});




app.get("/api/sqre",middleware.ensureAuthenticated,function(req,res){
	var id_me=req.user;
	var tb=req.query.tb;
	var vk=req.query.vk;
	var cv=req.query.cv;
	var v=req.query.v;
	var pk=relaciones[[tb]].pkey;
	connection.query('UPDATE LOW_PRIORITY '+tb+' SET '+cv+'=? WHERE '+pk+'=?',[v,vk], function(err, rows, fields) {
		if (!err){
			res.send(true);
		}else{
			//console.log('Nada');
			res.send(false);
		}
	});

});


app.get("/api/sqring",middleware.ensureAuthenticated,function(req,res){
	var id_me=req.user;
	var tb=idtbs[req.query.tb];
	var cp=req.query.cp.join(",");
	var cv=req.query.cv;
	var n=cv.length;
	var cmps="";
	for(var i=0;i<n;i++){
		cmps+='?,';
	}
	cmps=cmps.substring(0,cmps.length-1);
	//console.log(cv.join("|"));
	connection.query('INSERT INTO '+tb+' ('+cp+') VALUES ('+cmps+')',cv, function(err, rows, fields) {
		if (!err){
			res.send(true);
		}else{
			//console.log('Nada');
			//console.log(err);
			res.send(false);
		}
	});
});






app.get("/api/notifications",middleware.ensureAuthenticated,function(req,res){
	var id_usr=req.user;
	var bus=req.query.bus;
	connection.query('Select COUNT(S.ID_EVENTO) AS ID_SOLICITUD, SUM(S.FECHA_LIMITE<NOW()) AS VENCIDAS From eventos S WHERE (S.ID_RESPONSABLE=? OR S.ID_EVENTO IN(SELECT ID_EVENTO FROM eventos_invitados WHERE ID_USUARIO=?)) AND S.ID_EVENTO NOT IN(SELECT ID_SOLICITUD FROM eventos_seguimiento SE Where SE.AVANCE = 100) AND ((S.ORIGEN<>"A" AND S.ORIGEN<>"T" AND S.ORIGEN<>"C") OR (S.ORIGEN="C" AND S.ID_REL IN(SELECT ID_ACTA FROM actas_actas WHERE CERRADA=1))) AND S.ARCHIVAR=0;Select COUNT(ID_FECHA) AS INFORMES FROM spt_informes_fechas WHERE FECHA<CURDATE() AND PRESENTADO="0000-00-00" AND ID_INFORME IN(SELECT ID_INFORME FROM spt_informes WHERE ID_RESPONSABLE=?);SELECT COUNT(S.ID_ITEM) AS NEWSEGS FROM eventos_seguimiento S JOIN eventos E ON E.ID_EVENTO=S.ID_SOLICITUD WHERE (E.ID_RESPONSABLE=? OR E.ID_EVENTO IN(SELECT ID_EVENTO from eventos_invitados WHERE ID_USUARIO=? ORDER BY ID_EVENTO)) AND ((E.ORIGEN<>"A" AND E.ORIGEN<>"T" AND E.ORIGEN<>"C") OR (E.ORIGEN="C" AND E.ID_REL IN(SELECT ID_ACTA AS ID_REL FROM actas_actas WHERE CERRADA=1 ORDER BY ID_ACTA))) AND S.ID_ITEM NOT IN(SELECT ID_ITEM FROM eventos_seguimientos_hits WHERE ID_USUARIO=?) AND E.ARCHIVAR=0 ORDER BY S.ID_SOLICITUD;SELECT COUNT(E.ID_EVENTO) AS NEWTARS FROM eventos E WHERE (E.ID_RESPONSABLE=? OR E.ID_EVENTO IN(SELECT ID_EVENTO from eventos_invitados WHERE ID_USUARIO=? ORDER BY ID_EVENTO)) AND ((E.ORIGEN<>"A" AND E.ORIGEN<>"T" AND E.ORIGEN<>"C") OR (E.ORIGEN="C" AND E.ID_REL IN(SELECT ID_ACTA AS ID_REL FROM actas_actas WHERE CERRADA=1 ORDER BY ID_ACTA))) AND E.ID_EVENTO NOT IN(SELECT ID_EVENTO FROM eventos_hits WHERE ID_USUARIO=?) AND E.ARCHIVAR=0 ORDER BY E.ID_EVENTO;Select COUNT(ID_INGRESO) AS SINRE	From	 sgd_ingresos WHERE ID_FROM=? AND IO="O" AND HITS=0 AND SENT="1" AND ID_MEDIO="5" AND FECHA_RECIBIDO>"2017-02-28";SELECT I.ID_INGRESO, I.ASUNTO, CONCAT(UR.TX_PNOM_TERC," ",UR.TX_SNOM_TERC," ",UR.TX_PAPE_TERC," ",UR.TX_SAPE_TERC) AS REMITENTE, IF(I.ID_TO=? OR ID_DELEGADO=?,I.FECHA_RECIBIDO,CP.FECHA) AS fecha, COUNT(H.ID_INGRESO) AS hits FROM sgd_ingresos AS I JOIN sys_usuarios AS UR ON(I.ID_FROM=UR.ID_AUTO_USUA) LEFT JOIN  sgd_ingresos_copias AS CP ON CP.ID_INGRESO=I.ID_INGRESO AND CP.ID_USUARIO=? LEFT JOIN sgd_hits H ON H.ID_INGRESO=I.ID_INGRESO AND H.ID_USUARIO=? WHERE (I.ID_TO=? OR I.ID_DELEGADO=? OR CP.ID_USUARIO=?) AND I.SENT=1 AND I.CENTRAL=0 AND FINAL=0 GROUP BY I.ID_INGRESO HAVING hits=0 ORDER BY fecha DESC LIMIT 99',[id_usr,id_usr,id_usr,id_usr,id_usr,id_usr,id_usr,id_usr,id_usr,id_usr,id_usr,id_usr,id_usr,id_usr,id_usr,id_usr,id_usr], function(err, result, fields) {
		if (!err){
			res.json({success:true,result:result});
		}else{
			console.log(err);
			res.send(403);
		}
	});
});


app.get("/api/responseDb",middleware.ensureAuthenticated,function(req,res){
	var id_usr=req.user;
	var bus=req.query.bus;
	var search=req.query.search;
	var tux=req.query.tux;
	var undoopen=1;
	if(tux=="I"){
		var undoopen=0;
	}
	connection.query('SELECT D.ID_AUTO_UNDO, UPPER(D.TX_NOMB_UNDO) AS TX_NOMB_UNDO, U.ID_AUTO_USUA, UPPER(U.TX_PNOM_TERC) AS TX_PNOM_TERC, UPPER(U.TX_SNOM_TERC) AS TX_SNOM_TERC, UPPER(U.TX_PAPE_TERC) AS TX_PAPE_TERC, UPPER(U.TX_SAPE_TERC) AS TX_SAPE_TERC, LOWER(U.TX_MAIL_TERC) AS TX_MAIL_TERC FROM sgd_unidades_documentales D LEFT JOIN sys_r_unidades_documentales_usuarios R ON R.CD_AUTO_UNDO=D.ID_AUTO_UNDO AND R.ID_ESTA_UNDO_USUA=1 LEFT JOIN sys_usuarios U ON U.ID_AUTO_USUA=R.CD_AUTO_USUA AND U.TUX=? AND  U.BO_ESTA_USUA=1 AND  U.CD_CODI_EMPR=? WHERE D.CD_AUTO_EMPR=? AND D.BO_UNDO_OPEN=? AND (D.TX_NOMB_UNDO LIKE ? OR CONCAT(U.TX_PNOM_TERC," ",U.TX_SNOM_TERC," ",U.TX_PAPE_TERC," ",U.TX_SAPE_TERC) LIKE ? OR CONCAT(U.TX_PNOM_TERC," ",U.TX_PAPE_TERC," ",U.TX_SAPE_TERC) LIKE ? OR U.ID_IDEN_TERC LIKE ?) ORDER BY D.TX_NOMB_UNDO, CONCAT(U.TX_PNOM_TERC," ",U.TX_SNOM_TERC," ",U.TX_PAPE_TERC," ",U.TX_SAPE_TERC) LIMIT 100',[tux,bus,bus,undoopen,'%'+search+'%','%'+search+'%','%'+search+'%','%'+search+'%'], function(err, rows, fields) {
		if (!err){
			res.json({success:true,rows:rows});
		}else{
			res.send(403);
		}
	});

});




app.get("/api/responseDbDep",middleware.ensureAuthenticated,function(req,res){
	var id_usr=req.user;
	var bus=req.query.bus;
	var tux=req.query.tux;
	var search=req.query.search;
	var undoopen=1;
	var params=[bus,undoopen,'%'+search+'%'];
	var lent=search.split(" ");
	var word="";
	var sql='SELECT ID_AUTO_UNDO, UPPER(TX_NOMB_UNDO) AS TX_NOMB_UNDO FROM sgd_unidades_documentales WHERE CD_AUTO_EMPR=? AND BO_UNDO_OPEN=? AND (TX_NOMB_UNDO LIKE ?';
	for(var n=0;n<lent.length;n++){
		word=lent[n];
		params.push('%'+word+'%')
		sql+=' OR TX_NOMB_UNDO = ? ';
	}
	sql+=")";
	connection.query(sql,params, function(err, rows, fields) {
		if (!err){
			res.json({success:true,rows:rows});
			
		}else{
			console.log(err);
			res.send(403);
		}
	});
});



app.get("/api/lastInbox",middleware.ensureAuthenticated,function(req,res){
	var id_usr=req.user;
	var pg=req.query.pg;
	var nonread=req.query.nonread;
	var nonresp=req.query.nonresp;
	var searche=req.query.search;
	var folder=req.query.folder;
	var limit="20";
	if(pg>1){
		var base=(pg-1)*20;
		limit=base+",20";
	}
	
	var havingfilt="1";
	if(nonread==1){
		havingfilt += " AND (hits=0)";
	}
	if(nonresp==1){
		havingfilt += " AND (respuesta=0 AND req_reply>0)";
	}
	if(folder>0){
		havingfilt += " AND (id_folder="+folder+" OR id_folder_cp="+folder+")";
	}
	var condfilter='1';
	if(searche!=""){
		condfilter='(CONCAT(UR.TX_PNOM_TERC," ",UR.TX_SNOM_TERC," ",UR.TX_PAPE_TERC," ",UR.TX_SAPE_TERC) LIKE "%'+searche+'%" OR I.ASUNTO LIKE "%'+searche+'%" OR TD.NOMBRE LIKE "%'+searche+'%" OR I.CODIGO LIKE "%'+searche+'%")';
		
	}
	
	connection.query('SELECT I.ID_INGRESO AS id_ingreso,'+
		'I.ASUNTO AS asunto, '+
		'I.ID_FROM AS id_from,'+
		'I.ID_TO AS id_to,'+
		'I.ID_TIPO AS id_tipo,'+
		'I.ID_MEDIO AS id_medio,'+
		'CONCAT(UR.TX_PNOM_TERC," ",UR.TX_SNOM_TERC," ",UR.TX_PAPE_TERC," ",UR.TX_SAPE_TERC) AS usuario_remite, '+
		'I.NFL AS nfl, '+
		'IF(I.ID_TO=? OR ID_DELEGADO=?,I.FECHA_RECIBIDO,CP.FECHA) AS fecha, '+
		'(TD.PLAZO>0 OR I.REQ_REPLY) AS req_reply,'+
		'I.ID_DELEGADO AS delegad,'+
		'I.ID_RESPUESTA>0 AS respuesta, '+
		'COUNT(H.ID_INGRESO) AS hits,'+
		'CP.ID_REL as copia,'+
		'CP.ID_FOLDER AS id_folder_cp,'+
		'I.ID_FOLDER AS id_folder,'+
		'TD.NOMBRE AS tipodocumental, "I" AS origin '+
		'FROM sgd_ingresos AS I LEFT JOIN '+
		'sgd_trd_tipos_documentales AS TD ON I.ID_TIPO=TD.ID_TIPO LEFT JOIN '+
		'sys_usuarios AS UR ON(I.ID_FROM=UR.ID_AUTO_USUA) LEFT JOIN '+
		'sgd_ingresos_copias AS CP ON CP.ID_INGRESO=I.ID_INGRESO AND CP.ID_USUARIO=? LEFT JOIN sgd_hits H ON H.ID_INGRESO=I.ID_INGRESO AND H.ID_USUARIO=? WHERE (I.ID_TO=? OR ID_DELEGADO=? OR CP.ID_USUARIO=?) AND I.SENT=1 AND '+condfilter+' AND I.CENTRAL=0 '+
		'AND FINAL=0 GROUP BY I.ID_INGRESO HAVING '+havingfilt+' ORDER BY fecha DESC LIMIT '+limit,[id_usr,id_usr,id_usr,id_usr,id_usr,id_usr,id_usr], function(err, rows, fields) {
		if (!err){
			res.json({success:true,rows:rows});
		}else{
			res.send(403);
		}
	});

});


 
app.get("/api/lastMail",middleware.ensureAuthenticated,function(req,res){
	var id_usr=req.user;
	var pg=req.query.pg;
	var nonread=req.query.nonread;
	var nonresp=req.query.nonresp;
	var searche=req.query.search;
	var folder=req.query.folder;
	var limit="20";
	if(pg>1){
		var base=(pg-1)*20;
		limit=base+",20";
	}
	
	var havingfilt="1";
	if(nonread==1){
		havingfilt += " AND (hits=0)";
	}
	if(nonresp==1){
		havingfilt += " AND (respuesta=0 AND req_reply>0)";
	}
	if(folder>0){
		havingfilt += "AND 1";
	}
	var condfilter='1';
	if(searche!=""){
		condfilter='(M.NM_REMITE LIKE "%'+searche+'%" OR M.ASUNTO LIKE "%'+searche+'%" OR M.ID_MAIL LIKE "%'+searche+'%")';
	}
	
	connection.query('SELECT '+
		'M.ID_MAIL AS id_ingreso,'+
		'M.ASUNTO AS asunto,'+
		'M.REMITE AS id_from,'+
		'B.USER AS id_to,'+ 
		'0 AS id_tipo,'+ 
		'"7" AS id_medio,'+
		'M.REMITE IN(SELECT USER FROM sgd_mail_boxes WHERE 1 ORDER BY USER) AS id_folder,'+
		'M.NM_REMITE AS usuario_remite, M.ATTACH AS nfl, IF(CP.ID_USUARIO=?,CP.FECHA,M.FECHA) AS fecha, M.REQ_REPLY AS req_reply, M.ID_DELEGADO AS delegad, M.ID_RESPUESTA>0 AS respuesta, COUNT(HT.ID_USUARIO) AS hits, CP.ID_PERMISO AS copia, 0 AS id_folder_cp, B.USER AS tipodocumental,"E" AS origin FROM sgd_einbox M JOIN sgd_mail_boxes B'+' ON (M.ID_BOX=B.ID_BOX OR M.ID_DELEGADO=? OR M.ID_MAIL IN(SELECT ID_MAIL FROM sgd_einbox_perms WHERE ID_USUARIO=? ORDER BY ID_MAIL)) AND M.DESCARTADO=0 JOIN sgd_mail_boxes_users USR ON USR.ID_BOX=B.ID_BOX AND USR.ID_USUARIO=? LEFT JOIN sgd_ehits HT ON HT.ID_MAIL=M.ID_MAIL AND HT.ID_USUARIO=? LEFT JOIN sgd_einbox_perms CP ON CP.ID_MAIL=M.ID_MAIL AND CP.ID_USUARIO=? WHERE '+condfilter+' GROUP BY M.ID_MAIL HAVING '+havingfilt+' ORDER BY fecha DESC LIMIT '+limit,[id_usr,id_usr,id_usr,id_usr,id_usr,id_usr,id_usr], function(err, rows, fields) {
		if (!err){
			res.json({success:true,rows:rows});
		}else{
			console.log(err);
			res.send(403);
		}
	});
});

 
app.get("/api/getGD",middleware.ensureAuthenticated,function(req,res){
	var id_usr=req.user;
	var bus=req.query.bus;
	connection.query('Select '+
			'ID_DOCUMENTO,'+
			'ID_TIPO_DOCUMENTAL,'+
			'ID_INGRESO,'+
			'ID_CUSTODIA,'+
			'ID_ESPACIO,'+
			'ID_CREADOR,'+
			'ID_DEPENDENCIA,'+
			'FECHA,'+
			'DESCRIPCION,'+
			'CONTENTS,'+
			'ID_ESPACIO,'+
			'ID_ACTA,'+
			' From sgd_documental ' +
			'WHERE DEP.CD_AUTO_EMPR=? AND (ID_CUSTODIA=? OR ID_DOCUMENTO IN(SELECT PD.ID_DOCUMENTO FROM sgd_prestamos P JOIN sgd_prestamos_documentos PD ON P.ID_PRESTAMO=PD.ID_PRESTAMO WHERE PD.ID_APROBADO>0 AND P.ID_USUARIO=?)) GROUP BY D.ID_DOCUMENTO ORDER BY D.DESCRIPCION',[bus,id_usr,id_usr], function(err, rows, fields) {
		if (!err){
			res.json({success:true,rows:rows});
		}else{
			res.send(403);
		}
	});
});
 
 
app.get("/api/collections/trd_dep",middleware.ensureAuthenticated,function(req,res){
	var id_usr=req.user;
	var bus=req.query.bus;
	connection.query('Select DE.ID_AUTO_UNDO, DE.ID_CODI_UNDO, DE.TX_NOMB_UNDO, SE.ID_SERIE, SE.CODIGO AS CODIGO_SERIE, SE.NOMBRE SERIE, SS.ID_SUBSERIE, SS.CODIGO AS CODIGO_SUBSERIE, SS.NOMBRE AS SUBSERIE, TD.ID_TIPO, TD.CODIGO AS CODIGO_TIPO, TD.NOMBRE AS TIPO, R.ID_REL From sgd_unidades_documentales DE Inner Join sgd_trd_series SE On DE.ID_AUTO_UNDO = SE.ID_DEPENDENCIA Inner Join sgd_trd_subseries SS On SE.ID_SERIE = SS.ID_SERIE Inner Join sgd_trd_tipos_documentales TD ON TD.ID_SUBSERIE=SS.ID_SUBSERIE Left Join sgd_trd_tipos_usuarios AS R ON R.ID_TIPO=TD.ID_TIPO AND R.ID_USUARIO=? Where DE.CD_AUTO_EMPR=? GROUP BY TD.ID_TIPO ORDER BY DE.ID_AUTO_UNDO, SE.ID_SERIE, SS.ID_SUBSERIE, TD.ID_TIPO',[id_usr,bus], function(err, rows, fields) {
		if (!err){
			
			var arcollections={}
			var dependencias=[];
			var series=[];
			var subseries=[];
			var tipos=[];
			var record=null;
			for(var i=0;i<rows.length;i++){
				record=rows[i];
				if(!inArray(dependencias,"id",record.ID_AUTO_UNDO)){
					dependencias.push({"id":record.ID_AUTO_UNDO,"name":record.TX_NOMB_UNDO});
				}
				var id_dependencia=parseInt(record.ID_AUTO_UNDO);
				var cd_dependencia=record.ID_CODI_UNDO;
				var nm_dependencia=record.TX_NOMB_UNDO;
				var id_serie=parseInt(record.ID_SERIE);
				var cd_serie=record.CODIGO_SERIE;
				var nm_serie=record.SERIE;
				var id_sub=parseInt(record.ID_SUBSERIE);
				var cd_sub=record.CODIGO_SUBSERIE;
				var nm_sub=record.SUBSERIE;
				var id_tipo=parseInt(record.ID_TIPO);
				var cd_tipo=record.CODIGO_TIPO;
				var nm_tipo=record.NOMBRE_TIPO;
				var id_rel=record.ID_REL;

				if(!inArray(series,"id",id_serie)){
					series.push({"id":id_serie,"cd":cd_serie,"nm":nm_serie,"de":id_dependencia});
				}
				if(!inArray(subseries,"id",id_sub)){
					subseries.push({"id":id_sub,"cd":cd_sub,"nm":nm_sub,"se":id_serie});
				}
				if(!inArray(tipos,"id",id_tipo)){
					tipos.push({"id":id_tipo,"cd":cd_tipo,"nm":nm_tipo,"ss":id_sub,"pm":id_rel});
				}
			}
			res.json({success:true,dependencias:dependencias,series:series,subseries:subseries,tipos:tipos});
		}else{
			console.log(err);
			res.send(403);
		}
	});
});

  
app.get("/api/tareas/state_user",middleware.ensureAuthenticated,function(req,res){
	var id_usr=req.user;
	console.log("Consultado");
	connection.query('SELECT U.CD_ACTI_ECON_TERC, COUNT(S.ID_USUA_LOSE) AS SES FROM sys_usuarios AS U LEFT JOIN ad_log_sesiones AS S ON U.ID_AUTO_USUA=S.ID_USUA_LOSE AND MONTH(S.FE_FECH_INIC_LOSE)=MONTH(CURDATE()) AND YEAR(S.FE_FECH_INIC_LOSE)=YEAR(CURDATE()) WHERE U.ID_AUTO_USUA=?  GROUP BY U.ID_AUTO_USUA ORDER BY S.ID_USUA_LOSE',[id_usr], function(err, rows, fields) {
		if (!err){
			res.json({success:true,rows:rows});
		}else{
			res.end(403);
		}
	});
});


app.get("/api/agenda/items",middleware.ensureAuthenticated,function(req,res){
	var id_usr=req.user;
	var id_usr=req.query.usuario;
	connection.query('SELECT E.ID_EVENTO, E.INICIO, E.FINAL, E.DESCRIPCION, E.LUGAR, I.ID_DELEGADO, E.ID_TIPO_ACTIVIDAD, CONCAT(U.TX_PNOM_TERC," ",U.TX_SNOM_TERC) AS PROPEVENTO, CONCAT(U2.TX_PNOM_TERC," ",U2.TX_SNOM_TERC) AS DELEVENTO, TP.NOMBRE AS NOMBRE_TIPO, TP.COLOR, I.ASISTIRE FROM eventos E JOIN eventos_invitados I ON E.ID_EVENTO=I.ID_EVENTO LEFT JOIN sys_usuarios U ON U.ID_AUTO_USUA=I.ID_USUARIO LEFT JOIN sys_usuarios U2 ON U2.ID_AUTO_USUA=I.ID_DELEGADO LEFT JOIN ges_actividades_tipos TP ON TP.ID_TIPO_ACTIVIDAD=E.ID_TIPO_ACTIVIDAD WHERE (I.ID_USUARIO=? OR I.ID_DELEGADO=?) AND E.ORIGEN="A" ORDER BY E.ID_EVENTO',[id_usr,id_usr], function(err, rows, fields) {
		if (!err){
			res.json({success:true,rows:rows});
		}else{
			res.end(403);
		}
	});
});

 

app.get("/api/sistema/pausas_activas",middleware.ensureAuthenticated,function(req,res){
	var id_usr=req.user;
	var id_bus=req.bus;
	connection.query('SELECT GROUP_CONCAT(ID_PAUSA,"*",HORA) AS PAUSAS FROM sys_active_pause WHERE ID_EMPRESA=?',[id_bus], function(err, rows, fields) {
		if (!err){
			res.json({success:true,rows:rows});
		}else{
			res.end(403);
		}
	});
});

app.get("/api/agenda/items-serv",middleware.ensureAuthenticated,function(req,res){
	var id_usr=req.user;
	var id_usr=req.query.usuario;
	connection.query('SELECT E.ID_EVENTO, E.INICIO, E.FINAL, E.DESCRIPCION, E.LUGAR, I.ID_DELEGADO, E.ID_TIPO_ACTIVIDAD, CONCAT(U.TX_PNOM_TERC," ",U.TX_SNOM_TERC) AS PROPEVENTO, CONCAT(U2.TX_PNOM_TERC," ",U2.TX_SNOM_TERC) AS DELEVENTO, TP.NOMBRE AS NOMBRE_TIPO, TP.COLOR, I.ASISTIRE FROM eventos E JOIN eventos_invitados I ON E.ID_EVENTO=I.ID_EVENTO LEFT JOIN sys_usuarios U ON U.ID_AUTO_USUA=I.ID_USUARIO LEFT JOIN sys_usuarios U2 ON U2.ID_AUTO_USUA=I.ID_DELEGADO LEFT JOIN ges_actividades_tipos TP ON TP.ID_TIPO_ACTIVIDAD=E.ID_TIPO_ACTIVIDAD WHERE (I.ID_USUARIO=? OR I.ID_DELEGADO=? OR E.ID_RADICA=?) AND E.ORIGEN="A" GROUP BY E.ID_EVENTO ORDER BY E.ID_EVENTO',[id_usr,id_usr,id_usr], function(err, rows, fields) {
		if (!err){
			res.json({success:true,rows:rows});
		}else{
			console.log(err)
			res.end(403);
		}
	});
});


app.post("/api/addcom",middleware.ensureAuthenticated,function(req,res){
	var id_par=req.body.id_par;
	var txt=req.body.txt;
	var id_me=req.user;
	connection.query('INSERT INTO sys_anuncios_comenta (ID_USUARIO,COMENTARIO,ID_ANUNCIO,FECHA) VALUES (?,?,?,NOW())',[id_me,txt,id_par], function(err, result) {
		if(err) throw err;
		res.json(result);
	});
});

app.post("/api/delcom",middleware.ensureAuthenticated,function(req,res){
	var id_com=req.body.id_com;
	var id_me=req.user;
	connection.query('DELETE FROM sys_anuncios_comenta WHERE ID_COMENTARIO=?',[id_com], function(err, result) {
	//connection.end();
		if(err) throw err;
		res.send(true);
		
	});
});



app.get("/api/rest-tramit-get-info",function(req,res){
	var id_bus=req.query.id_bus;
	id_bus=id_bus/2/4/5;
	var secret=req.query.secret;
	//console.log();
	connection.query('SELECT ID_AUTO_EMPR, TX_NOMB_EMPR, LOGO64 FROM sys_empresas WHERE PUB=? AND ID_AUTO_EMPR=?',[secret,id_bus], function(err0, rows0, fields0) {
		if (!err0 && rows0.length>0){	
			res.send(rows0);
		}else{
			res.send(403);
		}
	});	
});

app.get("/api/rest-plan-avance",function(req,res){
	var id_bus=req.query.id_bus;
	id_bus=id_bus/2/4/5;
	var secret=req.query.secret;
	connection.query('SELECT P.NOMBRE, P.AVATO, P.CORTE_ANIO, P.CORTE_MES FROM ges_plan P JOIN sys_empresas E ON E.PR_PLAN=P.ID_PLAN WHERE E.PUB=? AND E.ID_AUTO_EMPR=?',[secret,id_bus], function(err0, rows0, fields0) {
		if (!err0 && rows0.length>0){	
			res.send(rows0);
		}else{
			res.send(403);
		}
	});	
});
app.get("/api/rest-tramit-get-list",function(req,res){
	var id_bus=req.query.id_bus;
	id_bus=id_bus/2/4/5;
	var secret=req.query.secret;
	connection.query('SELECT ID_AUTO_EMPR, TX_NOMB_EMPR FROM sys_empresas WHERE PUB=? AND ID_AUTO_EMPR=?',[secret,id_bus], function(err0, rows0, fields0) {
		if (!err0 && rows0.length>0){	
			connection.query('SELECT ID_TRAMITE, NOMBRE, ICONO, DESCRIPCION FROM sys_tramites WHERE ID_EMPRESA=?',[id_bus], function(err, rows, fields) {
				if (!err){
					res.send(rows);
				}else{
					res.send(403);
				}
			});

		}else{
			res.send(403);
		}
	});	
});



app.get("/api/rest-tramit-get-struct",function(req,res){
	var id_bus=req.query.id_bus;
	id_bus=id_bus/2/4/5;
	var secret=req.query.secret;
	var id_trm=req.query.id_trm;
	connection.query('SELECT ID_AUTO_EMPR, TX_NOMB_EMPR FROM sys_empresas WHERE PUB=? AND ID_AUTO_EMPR=?',[secret,id_bus], function(err0, rows0, fields0) {
		if (!err0 && rows0.length>0){	
			connection.query('SELECT T.ID_TRAMITE, T.NOMBRE, T.ICONO, T.DESCRIPCION, E.ID_ITEM, E.NOMBRE AS E_NOMBRE, E.DESCRIPCION AS E_DESCRIPCION, E.TIPO, E.IO, E.POS, E.PLAZO, D.TX_NOMB_UNDO FROM sys_tramites T JOIN sys_tramites_estructura E ON T.ID_TRAMITE=E.ID_TRAMITE JOIN sgd_unidades_documentales D ON D.ID_AUTO_UNDO=E.ID_DEPENDENCIA WHERE T.ID_EMPRESA=? AND T.ID_TRAMITE=? ORDER BY E.POS',[id_bus,id_trm], function(err, rows, fields) {
				if (!err){
					if(rows.length>0){
						var n_tramite=rows[0]["NOMBRE"];
						var rs='<h3>'+n_tramite+' <a href="#features" onclick="callInit()" class="btn btn-xs btn-danger pull-right"><i class="fa fa-angle-double-up"></i> Volver</a></h3><h4>ESTRUCTURA DEL TRÁMITE</h4><br />A continuación te mostramos los diferentes momentos del trámite, desde la solicitud del ciudadano hasta su resolución por parte de la entidad, haz clic en el primer paso para iniciar tu trámite<br /><hr /><ul class="list-group" id="lista-momentos">';
						for(i=0;i<rows.length;i++){
							var id_item=rows[i]["ID_ITEM"];
							var nm_item=rows[i]["E_NOMBRE"];
							var de_item=rows[i]["E_DESCRIPCION"];
							var tp_item=rows[i]["TIPO"];
							var pl_item=rows[i]["PLAZO"];
							var io_item=rows[i]["IO"];
							var dep_item=rows[i]["TX_NOMB_UNDO"];
							if(i==0){
								pl_item='';
							}else{
								pl_item=pl_item+' días hábiles';
							}
							if(io_item=="I" && tp_item==0){
								var clase="success";
								var icono="fa-play-circle";
								var claselink="link-cnv";
								var fn='loadItem(\''+id_item+'\')';
							}else{
								var clase="danger";
								var icono="fa-hourglass ";
								var claselink="";
								var fn='alert(\'Haz clic en el momento inicial del trámite\')';
							}
							rs+='<li class="list-group-item list-group-item-'+clase+' '+claselink+'" onclick="'+fn+'"><span><span style="font-size:30px;margin:5px;" class="fa '+icono+' pull-left"></span><b>'+nm_item+':</b> '+dep_item+'<br />'+de_item+'</span><span class="pull-right">'+pl_item+'</span></li>';
						}
						rs+='</ul>';
					}else{
						var rs='El trámite se encuentra en mantenimiento';
					}
					res.end(rs);
				}else{
					//console.log(err.message);
					res.end(403);
				}
			});

		}else{
			res.end(403);
		}
	});	
});




app.get("/api/rest-tramit-get-moment",function(req,res){
	var id_bus=req.query.id_bus;
	id_bus=id_bus/2/4/5;
	var secret=req.query.secret;
	var id_moment=req.query.id_moment;
	connection.query('SELECT ID_AUTO_EMPR, TX_NOMB_EMPR FROM sys_empresas WHERE PUB=? AND ID_AUTO_EMPR=?',[secret,id_bus], function(err0, rows0, fields0) {
		if (!err0 && rows0.length>0){	
			connection.query('SELECT T.ID_TRAMITE, T.NOMBRE AS TRAMITE, F.ID_CAMPO, F.NOMBRE, F.TIPO, F.REQ, F.DESCRIPCION, E.NOMBRE AS E_NOMBRE, E.DESCRIPCION AS E_DESCRIPCION, E.PLAZO, GROUP_CONCAT(CONCAT(SL.ID_SELECT,"|",SL.NOMBRE) SEPARATOR "*") AS SELECTERS FROM sys_tramites T JOIN sys_tramites_estructura E ON T.ID_TRAMITE=E.ID_TRAMITE JOIN sys_tramites_forms F ON F.ID_ITEM=E.ID_ITEM JOIN sgd_unidades_documentales D ON D.ID_AUTO_UNDO=E.ID_DEPENDENCIA LEFT JOIN sys_tramites_forms_select SL ON SL.ID_CAMPO=F.ID_CAMPO WHERE E.ID_ITEM=? GROUP BY F.ID_CAMPO ORDER BY F.POS',[id_moment], function(err, rows, fields) {
				if (!err){
					if(rows.length>0){
						var id_tramit=rows[0]["ID_TRAMITE"];
						var n_tramite=rows[0]["TRAMITE"];
						var n_momento=rows[0]["E_NOMBRE"];
						var d_momento=rows[0]["E_DESCRIPCION"];
						var d_plazo=rows[0]["PLAZO"];
						
						var rs='<h3>'+n_tramite+' <a href="#features" onclick=\'loadTrm("'+id_tramit+'")\' class="btn btn-xs btn-danger pull-right"><i class="fa fa-angle-double-up"></i> Volver</a> </h3><h4><b>MOMENTO DEL TRÁMITE:</b> '+n_momento+'</h4>'+d_momento+'<br /><hr /><form id="form-moment" method="post" class="form" enctype="multipart/form-data">'+
						'<input type="hidden" name="bus" value="'+id_bus+'">'+
						'<input type="hidden" name="sec" value="'+secret+'">'+
						'<input type="hidden" name="id_moment" value="'+id_moment+'">'+
						'<div class="form-group">'+
						'<label for="bd_identificacion">IDENTIFICACIÓN</label><div class="input-group"><div class="input-group-addon" title="Identificación del ciudadano" onclick="describeMe(event)"><i class="fa fa-question-circle stoppa"></i></div><input type="text" autofocus class="form-control" name="bd_identificacion" id="bd_identificacion" required />'+
						'</div></div>'+
						'<div class="form-group">'+
						'<label for="bd_nombres">NOMBRES</label><div class="input-group"><div class="input-group-addon" title="Nombre del solicitante" onclick="describeMe(event)"><i class="fa fa-question-circle stoppa"></i></div><input type="text" class="form-control" name="bd_nombres" id="bd_nombres" required />'+
						'</div></div>'+
						'<div class="form-group">'+
						'<label for="bd_apellidos">APELLIDOS</label><div class="input-group"><div class="input-group-addon" title="Apellidos del solicitante" onclick="describeMe(event)"><i class="fa fa-question-circle stoppa"></i></div><input type="text" class="form-control" name="bd_apellidos" id="bd_apellidos" required />'+
						'</div></div>'+
						'<div class="form-group">'+
						'<label for="bd_email">CORREO ELECTRÓNICO</label><div class="input-group"><div class="input-group-addon" title="Se requiere un correo electrónico para notificaciones y/o respuestas" onclick="describeMe(event)"><i class="fa fa-question-circle stoppa"></i></div><input type="email" class="form-control" name="bd_email" id="bd_email" required />'+
						'</div></div>';
						for(var i=0;i<rows.length;i++){
							var id_campo=rows[i]["ID_CAMPO"];
							var nm_campo=rows[i]["NOMBRE"];
							var de_campo=rows[i]["DESCRIPCION"];
							var tp_campo=rows[i]["TIPO"];
							var rq_campo=rows[i]["REQ"];
							var io_item=rows[i]["IO"];
							var dep_item=rows[i]["TX_NOMB_UNDO"];
							var selects=rows[i]["SELECTERS"];
							if(io_item=="I"){
								var clase="green";
								var icono="play_arrow";
								var claselink="link-cnv";
							}else{
								var clase="red lighten-5";
								var icono="pause_circle_outline";
								var claselink="";
							}
							if(rq_campo==1){
								requiredd="required";
							}else{
								requiredd="";
							}
							if(tp_campo<9){
								var tpcla="form-group";
							}else{
								var tpcla="form-group";
							}
							rs+='<div class="'+tpcla+'"><label for="bdc_'+id_campo+'">'+nm_campo+'</label><div class="input-group"><div class="input-group-addon" title="'+de_campo+'" onclick="describeMe(event)"><i class="fa fa-question-circle"></i></div>';
							
							if(tp_campo==1){
								rs+='<input type="text"  class="form-control campmoment_af'+id_moment+'" name="bdc_'+id_campo+'" id="bdc_'+id_campo+'" '+requiredd+' />';
							}else if(tp_campo==2){
								rs+='<input type="number" class="form-control campmoment_af'+id_moment+'" name="bdc_'+id_campo+'" id="bdc_'+id_campo+'" '+requiredd+' />';
							}else if(tp_campo==3){
								rs+='<input type="number" class="form-control campmoment_af'+id_moment+'" step="any" name="bdc_'+id_campo+'" id="bdc_'+id_campo+'" '+requiredd+' />';
							}else if(tp_campo==4){
								rs+='<input type="date" class="form-control campmoment_af'+id_moment+'" name="bdc_'+id_campo+'" id="bdc_'+id_campo+'" '+requiredd+' />';
							}else if(tp_campo==5){
								rs+='<input type="datetime" class="form-control campmoment_af'+id_moment+'" name="bdc_'+id_campo+'" id="bdc_'+id_campo+'" '+requiredd+' />';
							}else if(tp_campo==6){
								rs+='<select name="bdc_'+id_campo+'" id="bdc_'+id_campo+'" class="form-control campmoment_af'+id_moment+'"  '+requiredd+'><option value="1">SI</option><option value="0">NO</option></select>';
							}else if(tp_campo==7){
								var selectsa=selects.split("*");
								if(selectsa.length>0){
									rs+='<select class="form-control campmoment_af'+id_moment+'" name="bdc_'+id_campo+'" id="bdc_'+id_campo+'" '+requiredd+'>';
									for(var s=0;s<selectsa.length;s++){
										if(selectsa[s]!=""){
											var seleco=selectsa[s].split("|");
											var idsel=seleco[0];
											var nmsel=seleco[1];
											rs+='<option value="'+idsel+'">'+nmsel+'</option>';
										}
									}
									rs+='</select>';
								}else{
									rs+='<select name="bdc_'+id_campo+'" id="bdc_'+id_campo+'"><option value="null" class="form-control  campmoment_af'+id_moment+'">Indefinido</option></select>';
								}
							}else if(tp_campo==8){
								rs+='<textarea placeholder="" class="form-control campmoment_af'+id_moment+'" name="bdc_'+id_campo+'" id="bdc_'+id_campo+'" '+requiredd+'></textarea>';
							}else if(tp_campo==9){
								rs+='<input type="file" onchange="setFnm(event)" class="form-control campmoment_af'+id_moment+'" name="bdc_'+id_campo+'" id="bdc_'+id_campo+'" '+requiredd+' />';

							}else if(tp_campo==10){
								rs+='<input type="email" class="form-control campmoment_af'+id_moment+'" name="bdc_'+id_campo+'" id="bdc_'+id_campo+'" '+requiredd+' />';
							}else{
								rs+='<input type="text" class="form-control campmoment_af'+id_moment+'" name="bdc_'+id_campo+'" id="bdc_'+id_campo+'" '+requiredd+' />';
							}
							if(tp_campo<9){
								rs+='';
							}
							rs+='</div></div><br /><br />';
						}
						rs+='<div id="g-recaptcha" class="g-recaptcha" data-sitekey="6Lf2pAkUAAAAAJotvqCXC4-YIAgQ_yBiNYG1NwJ4"></div><br /><br /><div class="divider"></div><button class="btn btn-primary btn-xs" type="submit">Enviar</button> <input type="reset" class="btn btn-danger btn-xs" value="Cancelar" /></form><script type="text/javascript">$(function(){goForm("form-moment","tramit-container","");});</script>';
					}else{
						var rs='No se encontró el formulario';
					}
					setTimeout(function(){
						res.end(rs);
					},100);
					
				}else{
					//console.log(err.message);
					res.end(403);
				}
			});

		}else{
			res.end(403);
		}
	});	
});




app.post("/api/rest-tramit-new-thread",function(req,res){
	var form = new formidable.IncomingForm();
	var flees=[];
	form.on('fileBegin', function (name, file){
		var nome='F_' +parseInt(Math.random()*999999) + file.name;
		checkDirectorySync('./www');
		checkDirectorySync('./www/tmp_tramits');
		file.path = __dirname + '/www/tmp_tramits/'+nome;
		flees[name]=nome;
	});

	form.on('file', function (name, file){
		//console.log('Uploaded ' + file.name);
		
	});
	
	form.parse(req, function(erra, fields, files) {
	
		var id_bus=fields.bus;
		var secret=fields.sec;
		var id_moment=fields.id_moment;
		

		connection.query('SELECT ID_AUTO_EMPR, TX_NOMB_EMPR FROM sys_empresas WHERE PUB=? AND ID_AUTO_EMPR=?',[secret,id_bus], function(err0, rows0, fields0) {
			if (!err0 && rows0.length>0){	
				var requestQuery = fields["g-recaptcha-response"];
				console.log(requestQuery);
				if(requestQuery != null && requestQuery!=undefined){
					var response = requestQuery;
					var captchaUrl = "https://www.google.com/recaptcha/api/siteverify?secret=6Lf2pAkUAAAAADDGPUKrHk8ZQkdVSsEc1tFFIQl5&response=" +response;
					https.get(captchaUrl,function(resc) {
						if(resc){
							connection.query('SELECT T.ID_TRAMITE, T.NOMBRE AS TRAMITE, F.ID_CAMPO, F.NOMBRE, F.TIPO, F.REQ, F.DESCRIPCION, E.NOMBRE AS E_NOMBRE, E.DESCRIPCION AS E_DESCRIPCION, E.PLAZO, GROUP_CONCAT(CONCAT(SL.ID_SELECT,"|",SL.NOMBRE) SEPARATOR "*") AS SELECTERS FROM sys_tramites T JOIN sys_tramites_estructura E ON T.ID_TRAMITE=E.ID_TRAMITE JOIN sys_tramites_forms F ON F.ID_ITEM=E.ID_ITEM JOIN sgd_unidades_documentales D ON D.ID_AUTO_UNDO=E.ID_DEPENDENCIA LEFT JOIN sys_tramites_forms_select SL ON SL.ID_CAMPO=F.ID_CAMPO WHERE E.ID_ITEM=? GROUP BY F.ID_CAMPO ORDER BY F.POS',[id_moment], function(err, rows, fields22) {
							if (!err){
								if(rows.length>0){
									var id_tramit=rows[0]["ID_TRAMITE"];
									var bd_identificacion=fields.bd_identificacion;
									var bd_nombres=fields.bd_nombres;
									var bd_apellidos=fields.bd_apellidos;
									var bd_email=fields.bd_email;
									var fec=new Date();
									var anio=fec.getFullYear();
									var mes=fec.getMonth()+1;
									var dia=fec.getDate();
									var hora=fec.getHours();
									var minu=fec.getMinutes();
									
									var radicado="T-"+id_tramit+''+anio+''+mes+''+dia+''+hora+''+minu+''+parseInt(Math.random()*999);
									connection.query('INSERT INTO sys_tramites_hilos (ID_TRAMITE,IDENTIFICACION,NOMBRES,APELLIDOS,EMAIL,FECHA,RADICADO) VALUES ("'+id_tramit+'","'+bd_identificacion+'","'+bd_nombres+'","'+bd_apellidos+'","'+bd_email+'",NOW(),"'+radicado+'")', {}, function(err2, rows2, fields2) {
										if(!err2){
											var id_hilo = rows2.insertId;
											
											
											
										
											
											
											var querytwo='INSERT INTO sys_tramites_forms_records (ID_HILO,ID_CAMPO,VALOR) VALUES ';
											for(var i=0;i<rows.length;i++){
												var id_campo=rows[i]["ID_CAMPO"];
												var tp_campo=rows[i]["TIPO"];
												var cmp="";
												if(tp_campo==1 || tp_campo==10){
													cmp="VALTXT";
												}else if(tp_campo==2 || tp_campo==7){
													cmp="VALINT";
												}else if(tp_campo==3){
													cmp="VALDBL";
												}else if(tp_campo==4 || tp_campo==5){
													cmp="VALDAT";
												}else if(tp_campo==6){
													cmp="VALBOO";
												}else if(tp_campo==8){
													cmp="VALMEM";
												}else if(tp_campo==9){
													cmp="VALTXT";
												}
												if(tp_campo!=9){
													var valor=fields['bdc_'+id_campo];
												}else{
													var valio=flees['bdc_'+id_campo];
													if(valio!=undefined){
														var valor=valio;
														var oldPath='../www/tmp_tramits/'+valor;
														checkDirectorySync('../www');
														checkDirectorySync('../www/filehost');
														checkDirectorySync('../www/filehost/bus_'+id_bus);
														checkDirectorySync('../www/filehost/bus_'+id_bus+'/tramits');
														checkDirectorySync('../www/filehost/bus_'+id_bus+'/tramits/thread_'+id_hilo);
														newPath = '../www/filehost/bus_'+id_bus+'/tramits/thread_'+id_hilo+'/'+valor;
														fs.rename(oldPath, newPath,function(){});
													}else{
														var valor="";
													}
												}
												connection.query('INSERT INTO sys_tramites_forms_records (ID_HILO,ID_CAMPO,'+cmp+') VALUES ("'+id_hilo+'","'+id_campo+'","'+valor+'")', {});
											}
											if (!err2){
												res.end('<div class="card card-block text-center card-tramit"><div>'+
												'<div class="feature-icon">'+
												'<span class="fa fa-check-circle">'+
												'</div></div><div><h3>COMPLETADO</h3><p>El registro fue ingresado satisfactoriamente, el número de radicación es: </p><h4>'+radicado+'</h4><br /><a  class="btn btn-sm btn-success" href="index.php">Terminar</a></div></div>');
											}else{
												res.end('<div class="card card-block text-center card-tramit"><div class="panel-heading">CARAMBA!, ALGO HA FALLADO!</div><div class="panel-body">Lo sentimos, hubo un error al enviar la solicitud, inténtalo de nuevo más tarde o ponte en contacto con la entidad a través de otro medio.<br /><a  class="btn btn-sm btn-danger" href="index.php">Regresar</a></div></div>');
											}
										}else{
											console.log(err2);
										}
									});

								}else{
									var rs='No se encontró el formulario';
								}

							}else{
								res.end(403);
							}
						});
						}else{
							res.end(403);
						}
					});
				}else{
					res.end(403);
				}

			}else{
				res.end(403);
			}
		});	
		
    });
	
    return;
	
});

function checkDirectorySync(directory) {
  try {
    var crea=fs.statSync(directory);
  } catch(e) {    
    try {
        fs.mkdirSync(directory);
    } catch(e) {
        return e;
		
    }
  }
}

function getSid(id_cl){
	
	if(Promise){
		return new Promise(function(resolve, reject) {
			for(var n=0;n<connusers.length;n++){
				if(connusers[n].id==id_cl){
					resolve(connusers[n].sid);
					break;
				}
			}
		});
	}else{
		for(var n=0;n<connusers.length;n++){
			if(connusers[n].id==id_cl){
				return connusers[n].sid;
				break;
			}
		}
	}
}

function inArray(arreglo,prop,val){
	for(var i=0;i<arreglo.length;i++){
		if(arreglo[i][[prop]]==val){
			return true;
		}
	}
	return false;
}

app.get("/api/rest/get_print/",function(req,res){
	let username=req.query.credentials.client;
	let tk=req.query.credentials.token;
	let idped=req.query.id_pedido;
	let cond="1";
	let bus = getAuth(username,tk);
	let params=[bus];
	
	if(idped!=undefined){
		cond="PE.ID_PEDIDO=?";
		params=[bus,idped];
	}
	if(bus==0){
		res.json({success:false,err:"no autorizado"});
	}else{
		connection_rest.query('SELECT PE.ID_PEDIDO, M.NOMBRE AS MESA, M.TIPO, SP.ID_ITEM, S.ID_SILLA, S.OBSERVACION, SP.CANTIDAD, SP.LISTO, SP.ENTREGADO, P.NOMBRE, P.DESCRIPCION, C.ID_RACION, C.NOMBRE AS RACION, R.ESTADO, RO.ID_OPCION, RO.NOMBRE AS OPCION, ROP.OPTIS, CONCAT(U.NOMBRES," ",U.APELLIDOS) AS TENDER, P.PRECIO, P.PRECIO_DOM, PE.DENOM, PE.DIRECCION, PE.PAGADO FROM servicio SE JOIN pedidos PE ON PE.ID_SERVICIO=SE.ID_SERVICIO JOIN usuarios U ON PE.ID_TENDER=U.ID_USUARIO JOIN mesas M ON PE.ID_MESA=M.ID_MESA JOIN sillas AS S ON S.ID_PEDIDO=PE.ID_PEDIDO JOIN sillas_platos AS SP ON (S.ID_SILLA=SP.ID_SILLA) JOIN platos AS P ON (SP.ID_PLATO=P.ID_PLATO) LEFT JOIN platos_composicion C ON SP.ID_PLATO=C.ID_PLATO LEFT JOIN sillas_platos_composicion R ON R.ID_ITEM=SP.ID_ITEM AND R.ID_RACION=C.ID_RACION LEFT JOIN racion_opciones RO ON R.ID_OPCION=RO.ID_OPCION LEFT JOIN (SELECT ID_RACION,COUNT(ID_OPCION) OPTIS FROM racion_opciones WHERE ESTADO=1 GROUP BY ID_RACION ORDER BY ID_RACION)ROP ON ROP.ID_RACION=C.ID_RACION WHERE PE.PRINTED=0 AND SP.PRINTED=0 AND PE.CHEF<>"0000-00-00 00:00:00" AND SE.ID_SITIO=? AND '+cond+' GROUP BY C.ID_RACION, SP.ID_ITEM ORDER BY PE.ID_PEDIDO, S.ID_SILLA',[bus], function(err, result) {
			if (!err){
				if(result.length>0){
					res.json({success:true,result:result});
				}else{
					res.json({success:true,msg:"sin pedidos"});
				}
			}else{
				res.json({success:false,err:err})
			}
		});
	}
});



app.get("/api/rest/get_ped/",function(req,res){
	let username=req.query.credentials.client;
	let tk=req.query.credentials.token;
	let idp=req.query.pedido;
	let bus = getAuth(username,tk);
	if(bus==0){
		res.json({success:false,err:"no autorizado"});
	}else{
		connection_rest.query('SELECT CL.TIPO_ID, CL.IDENTIFICACION, CL.NOMBRE AS CLIENTE, CL.DIRECCION, CL.TELEFONO, CL.CORREO, F.PREFIJO, F.CONSECUTIVO, PE.ID_PEDIDO, M.NOMBRE AS MESA, M.TIPO, SP.ID_ITEM, S.ID_SILLA, S.OBSERVACION, SUM(SP.CANTIDAD) AS CANTIDAD, SP.LISTO, SP.ENTREGADO, P.NOMBRE, P.DESCRIPCION, P.PRECIO, P.PRECIO_DOM, P.ID_PLATO, I.PORCENTAJE, I.INCLUIDO, I.NOMBRE AS IMPUESTO, CONCAT(U.NOMBRES," ",U.APELLIDOS) AS TENDER FROM servicio SE JOIN pedidos PE ON PE.ID_SERVICIO=SE.ID_SERVICIO JOIN usuarios U ON PE.ID_TENDER=U.ID_USUARIO JOIN mesas M ON PE.ID_MESA=M.ID_MESA JOIN sillas AS S ON S.ID_PEDIDO=PE.ID_PEDIDO JOIN sillas_platos AS SP ON (S.ID_SILLA=SP.ID_SILLA) JOIN platos AS P ON (SP.ID_PLATO=P.ID_PLATO) LEFT JOIN facturas F ON F.ID_PEDIDO=PE.ID_PEDIDO LEFT JOIN clientes CL ON CL.ID_CLIENTE=F.ID_CLIENTE LEFT JOIN platos_impuestos PI ON PI.ID_PLATO=P.ID_PLATO LEFT JOIN impuestos I ON I.ID_IMPUESTO=PI.ID_IMPUESTO WHERE PE.CHEF<>"0000-00-00 00:00:00" AND SE.ID_SITIO=? AND PE.ID_PEDIDO=? GROUP BY P.ID_PLATO ORDER BY S.ID_SILLA',[bus,idp], function(err, result) {
			if (!err && result.length>0){
				if(result.length>0){
					res.json({success:true,result:result});
				}else{
					res.json({success:true,msg:"sin pedidos"});
				}
			}else{
				res.json({success:false,err:err})
			}
		});
	}
});


app.get("/api/rest/get_z/",function(req,res){
	let username=req.query.credentials.client;
	let tk=req.query.credentials.token;
	let idp=req.query.servicio;
	let bus = getAuth(username,tk);
	if(bus==0){
		res.json({success:false,err:"no autorizado"});
	}else{
		connection_rest.query('SELECT SE.ID_SERVICIO, M.TIPO, SUM(SP.CANTIDAD) AS CANTIDAD, P.PRECIO, P.PRECIO_DOM, I.PORCENTAJE, I.INCLUIDO, I.NOMBRE AS IMPUESTO FROM servicio SE JOIN pedidos PE ON PE.ID_SERVICIO=SE.ID_SERVICIO JOIN usuarios U ON PE.ID_TENDER=U.ID_USUARIO JOIN mesas M ON PE.ID_MESA=M.ID_MESA JOIN sillas AS S ON S.ID_PEDIDO=PE.ID_PEDIDO JOIN sillas_platos AS SP ON (S.ID_SILLA=SP.ID_SILLA) JOIN platos AS P ON (SP.ID_PLATO=P.ID_PLATO) JOIN facturas F ON F.ID_PEDIDO=PE.ID_PEDIDO LEFT JOIN clientes CL ON CL.ID_CLIENTE=F.ID_CLIENTE LEFT JOIN platos_impuestos PI ON PI.ID_PLATO=P.ID_PLATO LEFT JOIN impuestos I ON I.ID_IMPUESTO=PI.ID_IMPUESTO WHERE M.ID_SITIO=? AND PE.ID_SERVICIO=? GROUP BY P.ID_PLATO ORDER BY PE.ID_PEDIDO',[bus,idp], function(err, result) {
			if (!err && result.length>0){
				if(result.length>0){
					res.json({success:true,result:result});
				}else{
					res.json({success:true,msg:"sin pedidos"});
				}
			}else{
				res.json({success:false,err:err})
			}
		});
	}
});

app.get("/api/rest/get_y/",function(req,res){
	let username=req.query.credentials.client;
	let tk=req.query.credentials.token;
	let idp=req.query.servicio;
	let bus = getAuth(username,tk);
	if(bus==0){
		res.json({success:false,err:"no autorizado"});
	}else{
		connection_rest.query('SELECT SE.ID_SERVICIO, M.TIPO, SUM(SP.CANTIDAD) AS CANTIDAD, P.PRECIO, P.PRECIO_DOM, I.PORCENTAJE, I.INCLUIDO, I.NOMBRE AS IMPUESTO FROM servicio SE JOIN pedidos PE ON PE.ID_SERVICIO=SE.ID_SERVICIO JOIN usuarios U ON PE.ID_TENDER=U.ID_USUARIO JOIN mesas M ON PE.ID_MESA=M.ID_MESA JOIN sillas AS S ON S.ID_PEDIDO=PE.ID_PEDIDO JOIN sillas_platos AS SP ON (S.ID_SILLA=SP.ID_SILLA) JOIN platos AS P ON (SP.ID_PLATO=P.ID_PLATO) LEFT JOIN facturas F ON F.ID_PEDIDO=PE.ID_PEDIDO LEFT JOIN clientes CL ON CL.ID_CLIENTE=F.ID_CLIENTE LEFT JOIN platos_impuestos PI ON PI.ID_PLATO=P.ID_PLATO LEFT JOIN impuestos I ON I.ID_IMPUESTO=PI.ID_IMPUESTO WHERE M.ID_SITIO=? AND PE.ID_SERVICIO=? GROUP BY P.ID_PLATO ORDER BY PE.ID_PEDIDO',[bus,idp], function(err, result) {
			if (!err && result.length>0){
				if(result.length>0){
					res.json({success:true,result:result});
				}else{
					res.json({success:true,msg:"sin pedidos"});
				}
			}else{
				res.json({success:false,err:err})
			}
		});
	}
});

app.get("/api/rest/set_print/",function(req,res){
	let username=req.query.credentials.client;
	let tk=req.query.credentials.token;
	let pedidos=req.query.pedidos.split("|");
	let condis="";
	let pedis=[];
	for(var i=0;i<pedidos.length;i++){
		if(pedidos[i]!="" && pedidos[i]!=undefined){
			condis+="ID_PEDIDO=? OR ";
			pedis.push(pedidos[i]);
		}
	}
	condis += "0=1";
	let bus = getAuth(username,tk);
	if(bus==0){
		res.json({success:false,err:"no autorizado"});
	}else{
		connection_rest.query('UPDATE sillas_platos SET PRINTED=1 WHERE ID_SILLA IN(SELECT ID_SILLA FROM sillas WHERE ' + condis + ')',pedis, function(err, result) {
			if (!err){
				connection_rest.query('UPDATE pedidos SET PRINTED=1 WHERE ' + condis,pedis, function(err2, result2) {
					if (!err2){
						res.json({success:true,result:result2});
					}
				});
			}else{
				res.json({success:false,err:err})
			}
		});
	}
});

function getAuth(usr,auth){
	var obj = JSON.parse(fs.readFileSync('/var/node/ssx.json', 'utf8'));
	var obme=obj[[usr]];
	
	if(obme!=undefined && obme.auth==auth){
		return obme.bus;
	}else{
		return 0;
	}
}

